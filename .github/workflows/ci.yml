name: ci

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Print Nx version
        run: npx nx --version

      - name: Fetch base branch
        run: |
          git fetch origin main:main || true
          git branch -a

      - name: Affected - Lint
        run: |
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            npx nx affected -t lint --parallel=3 --base=origin/main --head=HEAD
          else
            npx nx run-many -t lint --parallel=3
          fi
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Affected - Test (with coverage)
        run: |
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            npx nx affected -t test --parallel=3 --coverage --base=origin/main --head=HEAD
          else
            npx nx run-many -t test --parallel=3 --coverage
          fi
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Integration Tests
        run: npm run test:integration
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

      - name: Integration Tests Coverage
        run: npm run test:integration:coverage
        continue-on-error: true
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        # Note: Coverage thresholds are disabled for integration tests
        # as many projects don't have integration tests yet

      - name: Upload Coverage Reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/**/lcov.info
          flags: integration
          name: integration-tests-coverage
          fail_ci_if_error: false

      - name: Affected - Build
        run: |
          if git rev-parse --verify origin/main >/dev/null 2>&1; then
            npx nx affected -t build --parallel=3 --base=origin/main --head=HEAD
          else
            npx nx run-many -t build --parallel=3
          fi
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

  e2e:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Prepare Database Directory
        working-directory: org
        run: mkdir -p data
      - name: Run Database Migrations
        working-directory: org
        run: npm run db:migrate:up
        env:
          DB_DIALECT: sqlite
          DB_STORAGE: ./data/test.sqlite
          JWT_SECRET: test-secret-key-for-ci
          JWT_EXPIRES_IN: 15m
          REFRESH_TOKEN_EXPIRES_IN: 7d
          NODE_ENV: test
          PORT: 3000
          FRONTEND_URL: http://localhost:4200
      - name: Run Playwright E2E (API only)
        working-directory: org
        env:
          CI: 'true'
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
          DB_DIALECT: sqlite
          DB_STORAGE: ./data/test.sqlite
          JWT_SECRET: test-secret-key-for-ci
          JWT_EXPIRES_IN: 15m
          REFRESH_TOKEN_EXPIRES_IN: 7d
          NODE_ENV: test
          PORT: 3000
          FRONTEND_URL: http://localhost:4200
        run: npx nx e2e e2e --skip-nx-cache -- --project=api
      - name: Upload API E2E Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-playwright-report
          path: org/e2e/playwright-report
          if-no-files-found: ignore
      - name: Upload API E2E Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-e2e-test-results
          path: org/e2e/test-results
        env:
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}

  e2e-ui-chromium:
    runs-on: ubuntu-latest
    needs: [ci, e2e]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps
      - name: Run Playwright UI E2E (Chromium only)
        env:
          CI: 'true'
          NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
        run: npx nx e2e e2e --skip-nx-cache -- --project=chromium
      - name: Upload UI E2E Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-playwright-report
          path: org/e2e/playwright-report
          if-no-files-found: ignore
